<html>
<head>
<title>Orbited + RedDwarf-JS Example</title>
<script src="http://localhost:9000/static/Orbited.js"></script>
<script>
document.domain = document.domain;
document.port   = document.port;
Orbited.settings.hostname = 'localhost';
Orbited.settings.port     = 9000;
TCPSocket = Orbited.TCPSocket;
</script>
<script src="javascripts/hash_table.js"></script>
<script src="javascripts/byte_array.js"></script>
<script src="javascripts/tcp_socket_ext.js"></script>
<script src="javascripts/simple_sgs_protocol.js"></script>
<script src="javascripts/client_channel.js"></script>
<script src="javascripts/message_filter.js"></script>
<script src="javascripts/sgs_event.js"></script>
<script src="javascripts/simple_client.js"></script>

<script>
var client;

function login(userName, password) {
  client = new SimpleClient('localhost', 1139);

  client.registerListener({
    on_loginSuccess:   function(event, client) { showMessage("Now logged in!",                           "#00aa00"); },
    on_loginFailure:   function(event, client) { showMessage("Login failure!",                           "#aa0000"); },
    on_logout:         function(event, client) { showMessage("Logged out.",                              "#00aa00"); },
    on_sessionMessage: function(event, client) { showMessage(event.sessionMessage,                       "#00aa00"); },
    on_channelMessage: function(event, client) { showChannelMessage(event.channelMessage, event.channel, "#00aa00"); },
    on_channelJoin:    function(event, client) { justJoinedChannel(event.channel);                                   },
    on_channelLeave:   function(event, client) { justLeftChannel  (event.channel);                                   },
  });

  client.login(userName || "guest-123", password || "");
}

function logout() {
  client.logout();
  client = null;
  clearChannelSelector();
}

function clearChannelSelector() {
  var channelSelector = document.getElementById("channelSelector");
  channelSelector.selectedIndex = 0;
  for (var i = channelSelector.options.length - 1; i >= 1; --i) {
    channelSelector.removeChild(channelSelector.options[i]);
  }
}

function sendMessage(msg) {
  var channelSelector = document.getElementById("channelSelector");
  if (channelSelector.value == "_default_") {
    client.sessionSend(msg);
    showMessage(msg, "#0000aa");
  } else {
    var channel = client.getChannelWithID(parseInt(channelSelector.value));
    client.channelSend(channel, msg);
    showMessage("[" + channel + "]: " + msg, "#0000aa");
  }
}

function showChannelMessage(msg, channel, color) {
  showMessage("[" + channel + "]: " + msg, color);
}

function showMessage(msg, color) {
  var paragraph = document.createElement('p');
  var lines = msg.split("\n");
  for (var i = 0, n = lines.length; i < n; ++i) {
    paragraph.appendChild(document.createTextNode(lines[i]));
    paragraph.appendChild(document.createElement("br"));
  }
  paragraph.style.color = color;
  document.getElementById('log').appendChild(paragraph);
  return msg;
}

function justJoinedChannel(channel) {
  var channelSelector = document.getElementById("channelSelector");
  var option = document.createElement("option");
  option.value = channel.uniqueId();
  option.appendChild(document.createTextNode(channel.name()));
  channelSelector.appendChild(option);
  showMessage("Joined channel " + channel, "#00aa00");
}

function justLeftChannel(channel) {
  var channelSelector = document.getElementById("channelSelector");
  var option = document.getElementById("channel_" + channel.uniqueId());
  channelSelector.removeChild(option);
  showMessage("Left channel " + channel, "#00aa00");
}

function doCommand() {
  try {
    var cmdBox = document.getElementById('cmdBox');
    var cmd = cmdBox.value;
    if (cmd.indexOf("login") === 0) {
      if (client) {
        showMessage("You're already logged in.", "#aa0000");
      } else {
        login(cmd.split(" ")[1]);
      }
    } else if (!client) {
      showMessage("You'd better log in first.", "#aa0000");
    } else if (cmd == "logout") {
      logout();
    } else {
      sendMessage(cmd)
    }
    cmdBox.value = "";
  } catch (x) {
    try {
      showMessage("Exception: " + x);
    } catch (xx) { // in case showMessage itself is broken
      if (typeof(console) !== 'undefined') {
        console.error(x);
      } else {
        alert(x);
      }
    }
  }
  return false;
}
</script>

</head>

<body>

<h1>RedDwarf-JS client example</h1>

<select id="channelSelector">
  <option value="_default_">[session]</option>
</select>

<div id="log">
</div>

<form onsubmit="return doCommand()">
  <input id="cmdBox">
</form>

<p>Available commands:</p>
<ul>
  <li>login</li>
  <li>logout</li>
  <li>look</li>
</ul>

</body>

</html>
